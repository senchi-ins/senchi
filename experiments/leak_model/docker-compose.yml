version: '3.8'

services:
  leak-sim:
    build: .
    volumes:
      - ./data:/app/data
      - ./output:/app/output
    environment:
      - PYTHONUNBUFFERED=1
      - SIM_HOMES=${SIM_HOMES:-1000}
      - SIM_START=${SIM_START:-2025-01}
      - SIM_END=${SIM_END:-2025-12}
      - SIM_OUTPUT=${SIM_OUTPUT:-synthetic_water_data_minute.csv.gz}
      - SIM_MEMORY_LIMIT=${SIM_MEMORY_LIMIT:-12G}
      - SIM_CPU_LIMIT=${SIM_CPU_LIMIT:-4}
      - SIM_BATCH_SIZE=${SIM_BATCH_SIZE:-50}
      - SIM_CHUNK_SIZE=${SIM_CHUNK_SIZE:-1000}
    deploy:
      resources:
        limits:
          memory: ${SIM_MEMORY_LIMIT:-12G}
          cpus: '${SIM_CPU_LIMIT:-4}'
        reservations:
          memory: ${SIM_MEMORY_RESERVATION:-12G}
          cpus: '${SIM_CPU_RESERVATION:-4}'
    command: [
      "uv", "run", "data/z_simd.py",
      "--homes", "${SIM_HOMES:-1000}",
      "--start", "${SIM_START:-2025-01}",
      "--end", "${SIM_END:-2025-12}",
      "--out", "${SIM_OUTPUT:-synthetic_water_data_minute.csv.gz}",
      "--batch-size", "${SIM_BATCH_SIZE:-50}",
      "--chunk-size", "${SIM_CHUNK_SIZE:-1000}"
    ] 